import math
import requests
import streamlit as st
import os

# Функция для расчёта расстояния между двумя точками (Haversine)
def haversine(lat1, lon1, lat2, lon2):
    R = 6371.0
    lat1_rad = math.radians(lat1)
    lon1_rad = math.radians(lon1)
    lat2_rad = math.radians(lat2)
    lon2_rad = math.radians(lon2)
    
    dlat = lat2_rad - lat1_rad
    dlon = lon2_rad - lon1_rad
    
    a = math.sin(dlat / 2)**2 + math.cos(lat1_rad) * math.cos(lat2_rad) * math.sin(dlon / 2)**2
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))
    
    distance = R * c
    return distance

# Функция для проверки, внутри ли точка полигона (ray-casting)
def is_inside_polygon(point, polygon):
    if not polygon:  # Проверка на пустой или None полигон
        raise ValueError("Полигон не загружен")
    x, y = point[0], point[1]  # lon, lat
    n = len(polygon)
    inside = False
    p1x, p1y = polygon[0]
    for i in range(n + 1):
        p2x, p2y = polygon[i % n]
        if y > min(p1y, p2y):
            if y <= max(p1y, p2y):
                if x <= max(p1x, p2x):
                    if p1y != p2y:
                        xinters = (y - p1y) * (p2x - p1x) / (p2y - p1y) + p1x
                    if p1x == p2x or x <= xinters:
                        inside = not inside
        p1x, p1y = p2x, p2y
    return inside

# Расстояние от точки до сегмента (a-b)
def distance_to_segment(p, a, b):
    px, py = p
    ax, ay = a
    bx, by = b
    abx = bx - ax
    aby = by - ay
    apx = px - ax
    apy = py - ay
    proj = apx * abx + apy * aby
    len_sq = abx * abx + aby * aby
    if len_sq == 0:
        return haversine(py, px, ay, ax)
    t = max(0, min(1, proj / len_sq))
    cx = ax + t * abx
    cy = ay + t * aby
    return haversine(py, px, cy, cx)

# Расчёт минимального расстояния до полигона
def distance_to_polygon(point, polygon):
    if not polygon:  # Проверка на пустой или None полигон
        raise ValueError("Полигон не загружен")
    min_dist = float('inf')
    n = len(polygon)
    for i in range(n):
        a = polygon[i]
        b = polygon[(i + 1) % n]
        dist = distance_to_segment(point, a, b)
        if dist < min_dist:
            min_dist = dist
    return min_dist

# Загрузка полигона Твери с OpenStreetMap
def load_tver_polygon():
    url = "http://polygons.openstreetmap.fr/get_geojson.py?id=77760&params=0"
    try:
        response = requests.get(url, timeout=10)
        if response.status_code == 200:
            data = response.json()
            if data['type'] == 'MultiPolygon':
                polygon = data['coordinates'][0][0]
            elif data['type'] == 'Polygon':
                polygon = data['coordinates'][0]
            else:
                raise ValueError("Неподдерживаемый тип GeoJSON")
            return [(lon, lat) for lon, lat in polygon]
        else:
            raise ValueError(f"Ошибка HTTP: {response.status_code}")
    except Exception as e:
        st.warning(f"Не удалось загрузить полигон Твери: {e}. Используется запасной полигон.")
        return fallback_tver_polygon()

# Упрощённый статический полигон Твери (около 100 точек)
def fallback_tver_polygon():
    return [
        (35.8327, 56.8969), (35.8368, 56.8937), (35.8450, 56.8910), (35.8542, 56.8887),
        (35.8634, 56.8860), (35.8726, 56.8833), (35.8818, 56.8806), (35.8910, 56.8779),
        (35.9002, 56.8752), (35.9094, 56.8725), (35.9186, 56.8698), (35.9278, 56.8671),
        (35.9370, 56.8644), (35.9462, 56.8617), (35.9554, 56.8590), (35.9646, 56.8563),
        (35.9738, 56.8536), (35.9830, 56.8509), (35.9922, 56.8482), (36.0014, 56.8455),
        (36.0106, 56.8428), (36.0198, 56.8401), (36.0290, 56.8374), (36.0382, 56.8347),
        (36.0474, 56.8320), (36.0566, 56.8293), (36.0658, 56.8266), (36.0750, 56.8239),
        (36.0842, 56.8212), (36.0934, 56.8185), (36.1026, 56.8158), (36.1118, 56.8131),
        (36.1210, 56.8104), (36.1302, 56.8077), (36.1394, 56.8050), (36.1486, 56.8023),
        (36.1578, 56.7996), (36.1670, 56.7969), (36.1762, 56.7942), (36.1854, 56.7915),
        (36.1946, 56.7888), (36.2038, 56.7861), (36.2130, 56.7834), (36.2222, 56.7807),
        (36.2314, 56.7780), (36.2406, 56.7753), (36.2498, 56.7726), (36.2590, 56.7699),
        (36.2682, 56.7672), (36.2774, 56.7645), (36.2866, 56.7618), (36.2958, 56.7591),
        (36.3050, 56.7564), (36.3142, 56.7537), (36.3234, 56.7510), (36.3326, 56.7483),
        (36.3418, 56.7456), (36.3510, 56.7429), (36.3602, 56.7402), (36.3694, 56.7375),
        (36.3786, 56.7348), (36.3878, 56.7321), (36.3970, 56.7294), (36.4062, 56.7267),
        (36.4154, 56.7240), (36.4246, 56.7213), (36.4338, 56.7186), (36.4430, 56.7159),
        (36.4522, 56.7132), (36.4614, 56.7105), (36.4706, 56.7078), (36.4798, 56.7051),
        (36.4890, 56.7024), (36.4982, 56.6997), (36.5074, 56.6970), (36.5166, 56.6943),
        (36.5258, 56.6916), (36.5350, 56.6889), (36.5442, 56.6862), (36.5534, 56.6835),
        (36.5626, 56.6808), (36.5718, 56.6781), (36.5810, 56.6754), (36.5902, 56.6727),
        (36.5994, 56.6700), (36.6086, 56.6673), (36.6178, 56.6646), (36.6270, 56.6619),
        (36.6362, 56.6592), (36.6454, 56.6565), (36.6546, 56.6538), (36.6638, 56.6511),
        (36.6730, 56.6484), (36.6822, 56.6457), (36.6914, 56.6430), (36.7006, 56.6403),
        (36.7098, 56.6376), (36.7190, 56.6349), (36.7282, 56.6322), (36.7374, 56.6295),
        (36.7466, 56.6268), (36.7558, 56.6241), (36.7650, 56.6214), (36.7742, 56.6187),
        (36.7834, 56.6160), (36.7926, 56.6133), (36.8018, 56.6106), (36.8110, 56.6079),
        (36.8202, 56.6052), (36.8294, 56.6025), (36.8386, 56.5998), (36.8478, 56.5971),
        (36.8570, 56.5944), (36.8662, 56.5917), (36.8754, 56.5890), (36.8846, 56.5863),
        (36.8938, 56.5836), (36.9030, 56.5809), (36.9122, 56.5782), (36.9214, 56.5755),
        (36.9306, 56.5728), (36.9398, 56.5701), (36.9490, 56.5674), (36.9582, 56.5647),
        (36.9674, 56.5620), (36.9766, 56.5593), (36.9858, 56.5566), (36.9950, 56.5539),
        (37.0042, 56.5512), (37.0134, 56.5485), (37.0226, 56.5458), (37.0318, 56.5431),
        (37.0410, 56.5404), (37.0502, 56.5377), (37.0594, 56.5350), (37.0686, 56.5323),
        (37.0778, 56.5296), (37.0870, 56.5269), (37.0962, 56.5242), (37.1054, 56.5215),
        (37.1146, 56.5188), (37.1238, 56.5161), (37.1330, 56.5134), (37.1422, 56.5107),
        (37.1514, 56.5080), (37.1606, 56.5053), (37.1698, 56.5026), (37.1790, 56.4999),
        (37.1882, 56.4972), (37.1974, 56.4945), (37.2066, 56.4918), (37.2158, 56.4891),
        (37.2250, 56.4864), (37.2342, 56.4837), (37.2434, 56.4810), (37.2526, 56.4783),
        (37.2618, 56.4756), (37.2710, 56.4729), (37.2802, 56.4702), (37.2894, 56.4675),
        (37.2986, 56.4648), (37.3078, 56.4621), (37.3170, 56.4594), (37.3262, 56.4567),
        (37.3354, 56.4540), (37.3446, 56.4513), (37.3538, 56.4486), (37.3630, 56.4459),
        (37.3722, 56.4432), (37.3814, 56.4405), (37.3906, 56.4378), (37.3998, 56.4351),
        (37.4090, 56.4324), (37.4182, 56.4297), (37.4274, 56.4270), (37.4366, 56.4243),
        (37.4458, 56.4216), (37.4550, 56.4189), (37.4642, 56.4162), (37.4734, 56.4135),
        (37.4826, 56.4108), (37.4918, 56.4081), (37.5010, 56.4054), (37.5102, 56.4027),
        (37.5194, 56.4000), (37.5286, 56.3973), (37.5378, 56.3946), (37.5470, 56.3919),
        (37.5562, 56.3892), (37.5654, 56.3865), (37.5746, 56.3838), (37.5838, 56.3811),
        (37.5930, 56.3784), (37.6022, 56.3757), (37.6114, 56.3730), (37.6206, 56.3703),
        (37.6298, 56.3676), (37.6390, 56.3649), (37.6482, 56.3622), (37.6574, 56.3595),
        (37.6666, 56.3568), (37.6758, 56.3541), (37.6850, 56.3514), (37.6942, 56.3487),
        (37.7034, 56.3460), (37.7126, 56.3433), (37.7218, 56.3406), (37.7310, 56.3379),
        (37.7402, 56.3352), (37.7494, 56.3325), (37.7586, 56.3298), (37.7678, 56.3271),
        (37.7770, 56.3244), (37.7862, 56.3217), (37.7954, 56.3190), (37.8046, 56.3163),
        (37.8138, 56.3136), (37.8230, 56.3109), (37.8322, 56.3082), (37.8414, 56.3055),
        (37.8506, 56.3028), (37.8598, 56.3001), (37.8690, 56.2974), (37.8782, 56.2947),
        (37.8874, 56.2920), (37.8966, 56.2893), (37.9058, 56.2866), (37.9150, 56.2839),
        (37.9242, 56.2812), (37.9334, 56.2785), (37.9426, 56.2758), (37.9518, 56.2731),
        (37.9610, 56.2704), (37.9702, 56.2677), (37.9794, 56.2650), (37.9886, 56.2623),
        (37.9978, 56.2596), (38.0070, 56.2569), (38.0162, 56.2542), (38.0254, 56.2515),
        (38.0346, 56.2488), (38.0438, 56.2461), (38.0530, 56.2434), (38.0622, 56.2407),
        (38.0714, 56.2380), (38.0806, 56.2353), (38.0898, 56.2326), (38.0990, 56.2299),
        (38.1082, 56.2272), (38.1174, 56.2245), (38.1266, 56.2218), (38.1358, 56.2191),
        (38.1450, 56.2164), (38.1542, 56.2137), (38.1634, 56.2110), (38.1726, 56.2083),
        (38.1818, 56.2056), (38.1910, 56.2029), (38.2002, 56.2002), (38.2094, 56.1975),
        (38.2186, 56.1948), (38.2278, 56.1921), (38.2370, 56.1894), (38.2462, 56.1867),
        (38.2554, 56.1840), (38.2646, 56.1813), (38.2738, 56.1786), (38.2830, 56.1759),
        (38.2922, 56.1732), (38.3014, 56.1705), (38.3106, 56.1678), (38.3198, 56.1651),
        (38.3290, 56.1624), (38.3382, 56.1597), (38.3474, 56.1570), (38.3566, 56.1543),
        (38.3658, 56.1516), (38.3750, 56.1489), (38.3842, 56.1462), (38.3934, 56.1435),
        (38.4026, 56.1408), (38.4118, 56.1381), (38.4210, 56.1354), (38.4302, 56.1327),
        (38.4394, 56.1300), (38.4486, 56.1273), (38.4578, 56.1246), (38.4670, 56.1219),
        (38.4762, 56.1192), (38.4854, 56.1165), (38.4946, 56.1138), (38.5038, 56.1111),
        (38.5130, 56.1084), (38.5222, 56.1057), (38.5314, 56.1030), (38.5406, 56.1003),
        (38.5498, 56.0976), (38.5590, 56.0949), (38.5682, 56.0922), (38.5774, 56.0895),
        (38.5866, 56.0868), (38.5958, 56.0841), (38.6050, 56.0814), (38.6142, 56.0787),
        (38.6234, 56.0760), (38.6326, 56.0733), (38.6418, 56.0706), (38.6510, 56.0679),
        (38.6602, 56.0652), (38.6694, 56.0625), (38.6786, 56.0598), (38.6878, 56.0571),
        (38.6970, 56.0544), (38.7062, 56.0517), (38.7154, 56.0490), (38.7246, 56.0463),
        (38.7338, 56.0436), (38.7430, 56.0409), (38.7522, 56.0382), (38.7614, 56.0355),
        (38.7706, 56.0328), (38.7798, 56.0301), (38.7890, 56.0274), (38.7982, 56.0247),
        (38.8074, 56.0220), (38.8166, 56.0193), (38.8258, 56.0166), (38.8350, 56.0139),
        (38.8442, 56.0112), (38.8534, 56.0085), (38.8626, 56.0058), (38.8718, 56.0031),
        (38.8810, 56.0004), (38.8902, 55.9977), (38.8994, 55.9950), (38.9086, 55.9923),
        (38.9178, 55.9896), (38.9270, 55.9869), (38.9362, 55.9842), (38.9454, 55.9815),
        (38.9546, 55.9788), (38.9638, 55.9761), (38.9730, 55.9734), (38.9822, 55.9707),
        (38.9914, 55.9680), (39.0006, 55.9653), (39.0098, 55.9626), (39.0190, 55.9599),
        (39.0282, 55.9572), (39.0374, 55.9545), (39.0466, 55.9518), (39.0558, 55.9491),
        (39.0650, 55.9464), (39.0742, 55.9437), (39.0834, 55.9410), (39.0926, 55.9383),
        (39.1018, 55.9356), (39.1110, 55.9329), (39.1202, 55.9302), (39.1294, 55.9275),
        (39.1386, 55.9248), (39.1478, 55.9221), (39.1570, 55.9194), (39.1662, 55.9167),
        (39.1754, 55.9140), (39.1846, 55.9113), (39.1938, 55.9086), (39.2030, 55.9059),
        (39.2122, 55.9032), (39.2214, 55.9005), (39.2306, 55.8978), (39.2398, 55.8951),
        (39.2490, 55.8924), (39.2582, 55.8897), (39.2674, 55.8870), (39.2766, 55.8843),
        (39.2858, 55.8816), (39.2950, 55.8789), (39.3042, 55.8762), (39.3134, 55.8735),
        (39.3226, 55.8708), (39.3318, 55.8681), (39.3410, 55.8654), (39.3502, 55.8627),
        (39.3594, 55.8600), (39.3686, 55.8573), (39.3778, 55.8546), (39.3870, 55.8519),
        (39.3962, 55.8492), (39.4054, 55.8465), (39.4146, 55.8438), (39.4238, 55.8411),
        (39.4330, 55.8384), (39.4422, 55.8357), (39.4514, 55.8330), (39.4606, 55.8303),
        (39.4698, 55.8276), (39.4790, 55.8249), (39.4882, 55.8222), (39.4974, 55.8195),
        (39.5066, 55.8168), (39.5158, 55.8141), (39.5250, 55.8114), (39.5342, 55.8087),
        (39.5434, 55.8060), (39.5526, 55.8033), (39.5618, 55.8006), (39.5710, 55.7979),
        (39.5802, 55.7952), (39.5894, 55.7925), (39.5986, 55.7898), (39.6078, 55.7871),
        (39.6170, 55.7844), (39.6262, 55.7817), (39.6354, 55.7790), (39.6446, 55.7763),
        (39.6538, 55.7736), (39.6630, 55.7709), (39.6722, 55.7682), (39.6814, 55.7655),
        (39.6906, 55.7628), (39.6998, 55.7601), (39.7090, 55.7574), (39.7182, 55.7547),
        (39.7274, 55.7520), (39.7366, 55.7493), (39.7458, 55.7466), (39.7550, 55.7439),
        (39.7642, 55.7412), (39.7734, 55.7385), (39.7826, 55.7358), (39.7918, 55.7331),
        (39.8010, 55.7304), (39.8102, 55.7277), (39.8194, 55.7250), (39.8286, 55.7223),
        (39.8378, 55.7196), (39.8470, 55.7169), (39.8562, 55.7142), (39.8654, 55.7115),
        (39.8746, 55.7088), (39.8838, 55.7061), (39.8930, 55.7034), (39.9022, 55.7007),
        (39.9114, 55.6980), (39.9206, 55.6953), (39.9298, 55.6926), (39.9390, 55.6899),
        (39.9482, 55.6872), (39.9574, 55.6845), (39.9666, 55.6818), (39.9758, 55.6791),
        (39.9850, 55.6764), (39.9942, 55.6737), (40.0034, 55.6710), (40.0126, 55.6683),
        (40.0218, 55.6656), (40.0310, 55.6629), (40.0402, 55.6602), (40.0494, 55.6575),
        (40.0586, 55.6548), (40.0678, 55.6521), (40.0770, 55.6494), (40.0862, 55.6467),
        (40.0954, 55.6440), (40.1046, 55.6413), (40.1138, 55.6386), (40.1230, 55.6359),
        (40.1322, 55.6332), (40.1414, 55.6305), (40.1506, 55.6278), (40.1598, 55.6251),
        (40.1690, 55.6224), (40.1782, 55.6197), (40.1874, 55.6170), (40.1966, 55.6143),
        (40.2058, 55.6116), (40.2150, 55.6089), (40.2242, 55.6062), (40.2334, 55.6035),
        (40.2426, 55.6008), (40.2518, 55.5981), (40.2610, 55.5954), (40.2702, 55.5927),
        (40.2794, 55.5900), (40.2886, 55.5873), (40.2978, 55.5846), (40.3070, 55.5819),
        (40.3162, 55.5792), (40.3254, 55.5765), (40.3346, 55.5738), (40.3438, 55.5711),
        (40.3530, 55.5684), (40.3622, 55.5657), (40.3714, 55.5630), (40.3806, 55.5603),
        (40.3898, 55.5576), (40.3990, 55.5549), (40.4082, 55.5522), (40.4174, 55.5495),
        (40.4266, 55.5468), (40.4358, 55.5441), (40.4450, 55.5414), (40.4542, 55.5387),
        (40.4634, 55.5360), (40.4726, 55.5333), (40.4818, 55.5306), (40.4910, 55.5279),
        (40.5002, 55.5252), (40.5094, 55.5225), (40.5186, 55.5198), (40.5278, 55.5171),
        (40.5370, 55.5144), (40.5462, 55.5117), (40.5554, 55.5090), (40.5646, 55.5063),
        (40.5738, 55.5036), (40.5830, 55.5009), (40.5922, 55.4982), (40.6014, 55.4955),
        (40.6106, 55.4928), (40.6198, 55.4901), (40.6290, 55.4874), (40.6382, 55.4847),
        (40.6474, 55.4820), (40.6566, 55.4793), (40.6658, 55.4766), (40.6750, 55.4739),
        (40.6842, 55.4712), (40.6934, 55.4685), (40.7026, 55.4658), (40.7118, 55.4631),
        (40.7210, 55.4604), (40.7302, 55.4577), (40.7394, 55.4550), (40.7486, 55.4523),
        (40.7578, 55.4496), (40.7670, 55.4469), (40.7762, 55.4442), (40.7854, 55.4415),
        (40.7946, 55.4388), (40.8038, 55.4361), (40.8130, 55.4334), (40.8222, 55.4307),
        (40.8314, 55.4280), (40.8406, 55.4253), (40.8498, 55.4226), (40.8590, 55.4199),
        (40.8682, 55.4172), (40.8774, 55.4145), (40.8866, 55.4118), (40.8958, 55.4091),
        (40.9050, 55.4064), (40.9142, 55.4037), (40.9234, 55.4010), (40.9326, 55.3983),
        (40.9418, 55.3956), (40.9510, 55.3929), (40.9602, 55.3902), (40.9694, 55.3875),
        (40.9786, 55.3848), (40.9878, 55.3821), (40.9970, 55.3794), (41.0062, 55.3767),
        (41.0154, 55.3740), (41.0246, 55.3713), (41.0338, 55.3686), (41.0430, 55.3659),
        (41.0522, 55.3632), (41.0614, 55.3605), (41.0706, 55.3578), (41.0798, 55.3551),
        (41.0890, 55.3524), (41.0982, 55.3497), (41.1074, 55.3470), (41.1166, 55.3443),
        (41.1258, 55.3416), (41.1350, 55.3389), (41.1442, 55.3362), (41.1534, 55.3335),
        (41.1626, 55.3308), (41.1718, 55.3281), (41.1810, 55.3254), (41.1902, 55.3227),
        (41.1994, 55.3200), (41.2086, 55.3173), (41.2178, 55.3146), (41.2270, 55.3119),
        (41.2362, 55.3092), (41.2454, 55.3065), (41.2546, 55.3038), (41.2638, 55.3011),
        (41.2730, 55.2984), (41.2822, 55.2957), (41.2914, 55.2930), (41.3006, 55.2903),
        (41.3098, 55.2876), (41.3190, 55.2849), (41.3282, 55.2822), (41.3374, 55.2795),
        (41.3466, 55.2768), (41.3558, 55.2741), (41.3650, 55.2714), (41.3742, 55.2687),
        (41.3834, 55.2660), (41.3926, 55.2633), (41.4018, 55.2606), (41.4110, 55.2579),
        (41.4202, 55.2552), (41.4294, 55.2525), (41.4386, 55.2498), (41.4478, 55.2471),
        (41.4570, 55.2444), (41.4662, 55.2417), (41.4754, 55.2390), (41.4846, 55.2363),
        (41.4938, 55.2336), (41.5030, 55.2309), (41.5122, 55.2282), (41.5214, 55.2255),
        (41.5306, 55.2228), (41.5398, 55.2201), (41.5490, 55.2174), (41.5582, 55.2147),
        (41.5674, 55.2120), (41.5766, 55.2093), (41.5858, 55.2066), (41.5950, 55.2039),
        (41.6042, 55.2012), (41.6134, 55.1985), (41.6226, 55.1958), (41.6318, 55.1931),
        (41.6410, 55.1904), (41.6502, 55.1877), (41.6594, 55.1850), (41.6686, 55.1823),
        (41.6778, 55.1796), (41.6870, 55.1769), (41.6962, 55.1742), (41.7054, 55.1715),
        (41.7146, 55.1688), (41.7238, 55.1661), (41.7330, 55.1634), (41.7422, 55.1607),
        (41.7514, 55.1580), (41.7606, 55.1553), (41.7698, 55.1526), (41.7790, 55.1499),
        (41.7882, 55.1472), (41.7974, 55.1445), (41.8066, 55.1418), (41.8158, 55.1391),
        (41.8250, 55.1364), (41.8342, 55.1337), (41.8434, 55.1310), (41.8526, 55.1283),
        (41.8618, 55.1256), (41.8710, 55.1229), (41.8802, 55.1202), (41.8894, 55.1175),
        (41.8986, 55.1148), (41.9078, 55.1121), (41.9170, 55.1094), (41.9262, 55.1067),
        (41.9354, 55.1040), (41.9446, 55.1013), (41.9538, 55.0986), (41.9630, 55.0959),
        (41.9722, 55.0932), (41.9814, 55.0905), (41.9906, 55.0878), (42.0000, 55.0851)
    ]

# Тарифы
rate_per_km = 32
cargo_prices = {
    'маленький': 350,
    'средний': 500,
    'большой': 800
}

# Геокодирование адреса через Яндекс
def geocode_address(address, api_key):
    url = f"https://geocode-maps.yandex.ru/1.x/?apikey={api_key}&geocode={address}&format=json"
    response = requests.get(url)
    if response.status_code == 200:
        data = response.json()
        try:
            pos = data['response']['GeoObjectCollection']['featureMember'][0]['GeoObject']['Point']['pos']
            lon, lat = map(float, pos.split(' '))
            return lat, lon
        except (IndexError, KeyError):
            raise ValueError("Адрес не найден. Уточните адрес (например, добавьте 'Тверь').")
    else:
        raise ValueError(f"Ошибка API: {response.status_code}")

# Расчёт стоимости
def calculate_delivery_cost(cargo_size, dest_lat, dest_lon):
    if cargo_size not in cargo_prices:
        raise ValueError("Неверный размер груза. Доступны: маленький, средний, большой")
    
    if not tver_polygon:  # Проверка на пустой полигон
        raise ValueError("Ошибка: полигон Твери не загружен")
    
    base_cost = cargo_prices[cargo_size]
    point = (dest_lon, dest_lat)
    try:
        if is_inside_polygon(point, tver_polygon):
            return base_cost
        else:
            dist_from_boundary = distance_to_polygon(point, tver_polygon)
            total_extra_distance = dist_from_boundary * 2
            extra_cost = total_extra_distance * rate_per_km
            return round(base_cost + extra_cost, 2)
    except ValueError as e:
        raise ValueError(f"Ошибка расчёта: {e}")

# Загрузка полигона один раз при запуске
try:
    tver_polygon = load_tver_polygon()
except Exception as e:
    st.error(f"Ошибка загрузки границы Твери: {e}. Используется запасной полигон.")
    tver_polygon = fallback_tver_polygon()

# Проверка, что полигон не None и не пустой
if not tver_polygon:
    st.error("Критическая ошибка: полигон Твери не инициализирован. Обратитесь к администратору.")
    tver_polygon = fallback_tver_polygon()  # Дополнительная попытка загрузки запасного полигона

st.title("Калькулятор стоимости доставки по Твери")
st.write("Введите адрес доставки и выберите размер груза.")

api_key = os.environ.get("API_KEY")
if not api_key:
    st.error("Ошибка: API-ключ не настроен. Обратитесь к администратору.")
else:
    cargo_size = st.selectbox("Размер груза", ["маленький", "средний", "большой"])
    address = st.text_input("Адрес доставки (например, 'Тверь, ул. Советская, 10')")

    if st.button("Рассчитать"):
        if address:
            try:
                dest_lat, dest_lon = geocode_address(address, api_key)
                cost = calculate_delivery_cost(cargo_size, dest_lat, dest_lon)
                st.success(f"Стоимость доставки: {cost} руб.")
            except ValueError as e:
                st.error(f"Ошибка: {e}")
        else:
            st.warning("Введите адрес.")
